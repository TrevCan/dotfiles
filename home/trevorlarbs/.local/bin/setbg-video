#!/bin/bash


PIDFILE="/var/run/user/$UID/setbg-video.pid"

declare -a PIDs

_screen() {
	xwinwrap -ov -ni -g "$1" -- mpv --fullscreen\
		--no-stop-screensaver \
		--loop-file \
		--mute=yes \
		--no-osc --no-osd-bar -wid WID --no-input-default-bindings \
		--input-ipc-server="/tmp/setbg-video_$!" \
		"$2" &
	PIDs+=($!)
	echo "aaa $!"
}

while read p; do
	[[ $(ps -p "$p" -o comm=) == "xwinwrap" ]] && kill "$p";
done < $PIDFILE

sleep 0.5

for i in $( xrandr -q | grep ' connected' | grep -oP '\d+x\d+\+\d+\+\d+')
do
	_screen "$i" "$1"
done

printf "%s\n" "${PIDs[@]}" > $PIDFILE
